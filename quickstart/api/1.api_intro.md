## 接口服务器
### http接口服务器包含以下功能:

|名称|说明|名称|说明|
|------|-------|-------|-------|
|智能路由|支持|并发数统计|支持|
|静态文件|支持|请求时长统计|支持|
|TLS|支持|请求结果统计|支持|
|主机头配置|支持|URL转跳|支持|
|自定义http头|支持|json输出|支持|
|gzip压缩|支持|xml输出|支持|
|deflate压缩|支持|OnlyAllowAjaxRequest|支持|
|jwt|支持|xsrf|支持|

## 服务器参数配置
### 1. 服务配置概况
    |-- [platName]
	|   -- servers 
	|       --[subsystemName]
	|          --api
	|             --conf
	|                --[tagName]
	|                     --router
    |                     --metric
    |                     --static
    |                     --auth
    |                     --header
    |   --var
    |       --db
    |          --oracle
    |       --influxdb
    |          --oracle
    |       --conf
    |          --[subsystemName]

`[platName]`： 平台名称或系统名称，`[subsystemName]`: 子系统名称


+ 服务器配置路径：/[platName]/[servers]/[subsystemName]/api/conf
+ 公共参数路径：/[platName]/var




|名称|必须|说明|
|------|------|------|
|[tagName]|必须|服务器主配置信息，包含服务器启动的必须参数,名称可以为任意字符,与启动的hydra实例匹配|
|router|必须|路由配置信息|
|metric|可空|influxdb配置信息，用于存放服务器实时请求数据(QPS,执行时长，执行结果等)|
|static|可空|静态文件配置，如路径，扩展名等|
|auth|可空|安全认证信息，包括:jwt,xsrf,api basic,auth2等|
|header|可空|所有请求都要返回的公共头信息|



### 2. 服务器主配置
服务器主配置信息，包含服务器启动的必须参数，配置路径为:`/[platName]/[servers]/[subsystemName]/api/conf/[tagName]`
```json
{
    "address":":8080",
    "status":"start",
    "engines":"monitor",
    "tls":{
        "cert":"../www.baidu.com.crt",
        "key":"../baidu2017098773.key"
    },
    "metric":"@domain/var/influxdb/metric"
}
```

|参数名|必须|说明|
|:------|:-------:|:------|
|address|必须|服务器启动地址,有效的格式为`[ip]:<port>`,ip地址为空时为本机所有ip|
|status|必须|服务器状态，可选值为: start(启动)，停止(stop)，为start时会尝试启动服务器|
|engines|可空|引擎配置参数，使用了内置引擎时必须填写，多个擎使用逗号分隔。内置的引擎有:`alarm`,`monitor`,`file`等,未配置则不能使用内置引擎|
|tls|可空|tls证书配置，未配置则不启动tls|
|metric|可空|未配置时查找当前配置节点的子节点中是否存在名称为 `metric` 的配置，没有则不启动metric|

### 3. 路由配置
配置服务器请求URL的规则与内部服务的映射关系，和请求执行期间的参数。未配置路由规则服务器就无法对外提供任何服务：
```json
{
    "routers":[
        {
            "name":"/order/:a",
            "engine":"go",
            "action":"get,post",
            "service":"/order/@a",
            "args":"setting=s1"
        }
    ],
    "args":"db=oracle"
}
``` 

|参数名|必须|说明|
|:------|:-------:|:------|
|.routers|必须|路由列表|
|.args|可选|所有路由共用的全局配置参数|
|.routers.name|必须|外部服务请求规则，支持以冒号开头的通用配符，也支持正则表达式。如`/order/request`全字匹配路径为/order/request的请求地址，`/order/:a`,匹配以`/order/`开头的任何路径，并将`:a`的实际值作为变量`@a`保存，当前配置节点的其它参数可用使用`@a`使用该值|
|.routers.service|必须|当前资源映射的内部服务名称，支持变量翻译|
|.routers.engine|可选|未指定时为`*`,支持所有引擎，可选的引擎名称有`go`,`alarm`等|
|.routers.action|可选|允许的http请求方式，如:`GET`,`POST`,`HEAD`,`DELETE`,`PUT`,	`OPTIONS`,`TRACE`,`PATCH` 未指定时为`GET`。多种请求方式用逗号分隔|
|.routers.args|可选|当前路由规则对应的服务配置参数，系统会自动与`.args`合并，以当前的配置覆盖全局配置|

###  4. hydra支持4种路由配置

 + 静态路由

`/`

`/static` 

以固定名称作为路径全称进行匹配

+ 命名路由

`/:name`

`/(:name)`

`/:name1/:name2`

`/:name1-:name2`

`/(:name1)sss(:name2)`

+ 通配路由

`/*name`

`/ttt/*name`

`/sss(*name)`

路由参数支持*通配符

+ 正则路由

`/(:name.*)`

`/(:name[0-9]+)`

`/(:name1)-(:name2[0-9]+)`

路由参数支持正则约束，不符合条件的参数会抛出404错误


### 5. 路由优先级

+ 静态路由和其它形式的路由都匹配时，静态路由优先，跟添加的顺序无关，如：

`/abc`

`/(:name)`

那么对于请求/abc，则/abc会匹配

+ 多个动态路由均匹配时，先出现静态部分的路由优先，如：

`/(:name1)/(:name1)abc`

`/(:name1)/abc(:name1)abc(:name2)abc`

那么对于请求/abc/abc123abc123abc，则/(:name1)/abc(:name1)abc(:name2)abc会匹配

+ 其它路由之间根据添加的顺序，先添加的优先。